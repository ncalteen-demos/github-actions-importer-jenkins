# Customize GitHub Actions Importer's Behavior with Custom Transformers

In this lab you will build upon the `dry-run` command to override GitHub Actions
Importer's default behavior and customize the converted workflow using custom
transformers.

Custom transformers can be used to:

1. Convert items that are not automatically converted
2. Convert items that were automatically converted using different actions
3. Convert environment variable values differently
4. Convert references to runners to use a different runner name

## Step 1: Perform a Dry Run

You will be performing a dry run and inspecting the workflow that is converted.

1. Open a new terminal window
2. Run the following command

   ```bash
   gh actions-importer dry-run jenkins --source-url http://localhost:8080/job/test_pipeline --output-dir tmp/dry-run
   ```

The converted workflow that is generated by the above command can be seen below.
As you can see, it contains a `sleep` step that was not automatically converted.

```yaml
name: test_pipeline

on:
  push:
    paths: '*'
  schedule:
    - cron: 0-29/10 * * * *

env:
  DISABLE_AUTH: 'true'
  DB_ENGINE: sqlite

jobs:
  build:
    runs-on:
      - self-hosted
      - TeamARunner

    steps:
      - name: checkout
        uses: actions/checkout@v3.5.0

      - name: echo message
        run: echo "Database engine is ${{ env.DB_ENGINE }}"
      #     # This item has no matching transformer
      #     - sleep:
      #       - key: time
      #         value:
      #           isLiteral: true
      #           value: 80

      - name: echo message
        run: echo "DISABLE_AUTH is ${{ env.DISABLE_AUTH }}"
  test:
    runs-on:
      - self-hosted
      - TeamARunner
    needs: build

    steps:
      - name: checkout
        uses: actions/checkout@v3.5.0

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2.7.0
        if: always()
        with:
          junit_files: '**/target/*.xml'
```

## Step 2: Create a Custom Transformer

When creating a custom transformer, there are two main factors to consider:

- What is the "identifier" of the step to customize? The identifier will be the
  key of a key value pair within the step of a Jenkinsfile. In this case, it is
  `sleep`.
- What is the desired Actions syntax to use? After some research, you have
  determined that the following bash script will provide similar functionality:

  ```yaml
  - name: Sleep for 80 seconds
    shell: bash
    run: sleep 80s
  ```

With this information, you can write the custom transformer. Custom transformers
use a DSL built on top of Ruby and should be defined in a file with the `.rb`
file extension. Transformers can use any valid Ruby syntax. They should return a
`Hash` that represents the YAML to generate for a given step.

1. Create a new file named `transformers.rb`
2. Add the following code to `transformers.rb`

   ```ruby
   transform "sleep" do |item|
     wait_time = item["arguments"][0]["value"]["value"]

     {
       "name": "Sleep for #{wait_time} seconds",
       "run": "sleep #{wait_time}s",
       "shell": "bash"
     }
   end
   ```

This will define a `transform` method for the `sleep` identifier. GitHub Actions
Importer will use this method to convert a step with the provided identifier.
The `item` parameter will include the original values configured in Jenkins.

## Step 3: Perform Another Dry Run

Now you can perform another `dry-run`. This time, include the
`--custom-transformers` CLI option to provide the custom transformer you
created.

1. Open a new terminal window
2. Run the following command

   ```bash
   gh actions-importer dry-run jenkins --source-url http://localhost:8080/job/test_pipeline --output-dir tmp/dry-run --custom-transformers transformers.rb
   ```

Open the workflow that is generated and inspect the contents. Now the `sleep`
step is converted and uses the customized behavior.

```diff
- #     # This item has no matching transformer
- #     - sleep:
- #       - key: time
- #         value:
- #           isLiteral: true
- #           value: 80
+  - name: Sleep for 80 seconds
+    run: sleep 80s
+    shell: bash
```

## Step 4: Create a Custom Transformer for a Known Step

You can also override GitHub Actions Importer's default behavior. In this
scenario, you may not want to use the third-party action for publishing junit
test results.

In this case, the identifier for the step to customize is `junit`, and the
desired GitHub Actions syntax is as follows.

```yaml
- uses: actions/upload-artifact@v3
  with:
    name: junit-artifact
    path: path/to/artifact/world.txt
```

In order to build this custom transformer, you need to provide the path to the
test results to the `actions/upload-artifact@v3` step. You can inspect the
`item` keyword to find this information.

1. Add the following code to `transformers.rb`

   ```ruby
   transform "junit" do |item|
     puts "This is the item: #{item}"
   end
   ```

   Since we don't know the file path to the test results, this transformer will
   simply output the `item` to the console. We can use this to find the path and
   update the transformer with the correct output.

2. Perform another dry run, making sure to include the `--custom-transformers`
   option

   ```bash
   $ gh actions-importer dry-run jenkins --source-url http://localhost:8080/job/test_pipeline --output-dir tmp/dry-run --custom-transformers transformers.rb
   [2022-08-20 22:08:20] Logs: 'tmp/dry-run/log/actions-importer-20220916-022628.log'
   This is the item: {"name"=>"junit", "arguments"=>[{"key"=>"testResults", "value"=>{"isLiteral"=>true, "value"=>"**/target/*.xml"}}]}
   [2022-08-20 22:08:20] Output file(s):
   [2022-08-20 22:08:20]   tmp/dry-run/test_pipeline/.github/workflows/test_pipeline.yml
   ```

   From the console output, you know that `item` has the following structure.

   ```ruby
   {
     "name"=>"junit",
     "arguments"=>[
       {
         "key"=>"testResults",
         "value"=>{
           "isLiteral"=>true,
           "value"=>"**/target/*.xml"
         }
       }
     ]
   }
   ```

3. Edit `transformers.rb`, replacing the `junit` transformer with the following
   code

   ```ruby
   transform "junit" do |item|
     test_results = item["arguments"].find{ |a| a["key"] == "testResults" }
     file_path = test_results.dig("value", "value")

     {
       "uses" => "actions/upload-artifact@v3",
       "with" => {
         "name" => "junit-artifact",
         "path" => file_path
       }
     }
   end
   ```

4. Perform another dry run, making sure to include the `--custom-transformers`
   option

   ```bash
   gh actions-importer dry-run jenkins --source-url http://localhost:8080/job/test_pipeline --output-dir tmp/dry-run --custom-transformers transformers.rb
   ```

When you open the converted workflow, the
`EnricoMi/publish-unit-test-result-action@v1.7` action will have been replaced
with the customized steps.

```diff
-    - name: Publish test results
-      uses: EnricoMi/publish-unit-test-result-action@v1.7
-      if: always()
-      with:
-        files: "**/target/*.xml"
+    - uses: actions/upload-artifact@v3
+      with:
+        name: junit-artifact
+        path: "**/target/*.xml"
```

## Step 5: Create a Custom Transformer for Environment Variables

You can also use custom transformers to edit the values of environment variables
in converted workflows. In this example, you will be updating the `DB_ENGINE`
environment variable to be `mongodb` instead of `sqlite`.

1. Edit `transformers.rb`, adding the following line to the top

   ```ruby
   env "DB_ENGINE", "mongodb"
   ```

   In this example, the first parameter to the `env` method is the environment
   variable name and the second is the updated value.

2. Perform another dry run, making sure to include the `--custom-transformers`
   option

   ```bash
   gh actions-importer dry-run jenkins --source-url http://localhost:8080/job/test_pipeline --output-dir tmp/dry-run --custom-transformers transformers.rb
   ```

When you open the converted workflow the `DB_ENGINE` environment variable will
be set to `mongodb`.

```diff
env:
  DISABLE_AUTH: 'true'
-  DB_ENGINE: sqlite
+  DB_ENGINE: mongodb
```

## Step 6: Create a Custom Transformer for Runners

You can use custom transformers to dictate which runners the converted workflows
should use. To do so, make note of the following:

- What is the label of the runner in Jenkins to update? In this case, it is
  `TeamARunner`.
- What is the label of the runner to use in GitHub Actions? In this case, we
  will use `ubuntu-latest`.

1. Edit `transformers.rb`, adding the following line underneath the `env`
   statement.

   ```ruby
   runner "TeamARunner", "ubuntu-latest"
   ```

   The first parameter to the `runner` method is the Jenkins label and the
   second is the Actions runner label.

2. Perform another dry run, making sure to include the `--custom-transformers`
   option

   ```bash
   gh actions-importer dry-run jenkins --source-url http://localhost:8080/job/test_pipeline --output-dir tmp/dry-run --custom-transformers transformers.rb
   ```

When you open the converted workflow the `runs-on` statement will use the
customized runner label.

```diff
runs-on:
-  - self-hosted
-  - TeamARunner
+  - ubuntu-latest
```

## Next lab

[Perform a Production Migration](6-migrate.md)
